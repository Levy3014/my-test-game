<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Hex Conquest - Expanded</title>
<style>
  body {
    margin: 0; padding: 0; background: #222; color: white;
    font-family: Arial, sans-serif;
    user-select: none;
    display: flex;
    height: 100vh;
    overflow: hidden;
  }
  #container {
    flex: 1;
    display: flex;
    flex-direction: column;
    max-width: 900px;
    margin: 0 auto;
    user-select: none;
  }
  canvas {
    background: #333;
    border-radius: 8px;
    border: 2px solid #555;
    flex: 1;
  }
  #sidebar {
    width: 300px;
    background: #111;
    padding: 20px;
    box-sizing: border-box;
    border-left: 2px solid #444;
    display: flex;
    flex-direction: column;
  }
  button {
    background: #3498db;
    border: none;
    padding: 10px 20px;
    margin: 8px 0;
    font-size: 16px;
    color: white;
    cursor: pointer;
    border-radius: 6px;
  }
  button:disabled {
    background: #555;
    cursor: not-allowed;
  }
  h2, h3 {
    margin: 10px 0 5px 0;
  }
  #tooltip {
    position: absolute;
    background: #222;
    color: #eee;
    border: 1px solid #555;
    padding: 6px 8px;
    border-radius: 4px;
    pointer-events: none;
    font-size: 14px;
    visibility: hidden;
    max-width: 200px;
    z-index: 10;
  }
  #playerInfo {
    margin-bottom: 10px;
  }
  .unit-icon {
    display: inline-block;
    width: 20px; height: 20px;
    margin-right: 5px;
    vertical-align: middle;
  }
  .unit-icon.soldier {
    background: url('https://img.icons8.com/ios-filled/50/ffffff/soldier-helmet.png') no-repeat center center;
    background-size: contain;
  }
  .unit-icon.fort {
    background: url('https://img.icons8.com/ios-filled/50/ffffff/castle.png') no-repeat center center;
    background-size: contain;
  }
  #phaseDisplay {
    margin-bottom: 15px;
    font-weight: bold;
    font-size: 18px;
  }
  #moneyDisplay {
    margin-bottom: 15px;
  }
  #shop {
    border-top: 1px solid #444;
    padding-top: 15px;
    flex-grow: 1;
  }
  #shop button {
    width: 100%;
  }
</style>
</head>
<body>

<div id="container">
  <canvas id="canvas" width="900" height="800"></canvas>
  <div id="tooltip"></div>
</div>

<div id="sidebar">
  <div id="playerInfo"></div>
  <div id="moneyDisplay"></div>
  <div id="phaseDisplay"></div>
  
  <div id="shop">
    <h3>Shop</h3>
    <button id="buySoldier" disabled>Buy Soldier (10 Gold)</button>
    <button id="buildFort" disabled>Build Fort (20 Gold)</button>
  </div>
  
  <button id="endTurnBtn" disabled>End Turn</button>
</div>

<script>
  // Basic setup
  const canvas = document.getElementById('canvas');
  const ctx = canvas.getContext('2d');
  const tooltip = document.getElementById('tooltip');
  const playerInfoDiv = document.getElementById('playerInfo');
  const moneyDisplay = document.getElementById('moneyDisplay');
  const phaseDisplay = document.getElementById('phaseDisplay');
  const buySoldierBtn = document.getElementById('buySoldier');
  const buildFortBtn = document.getElementById('buildFort');
  const endTurnBtn = document.getElementById('endTurnBtn');

  const hexSize = 30;
  const mapRadius = 6;

  // Game State
  let players = [
    { id: 0, name: 'Player 1', color: '#3498db', money: 50, bases: [], units: [] },
    { id: 1, name: 'Player 2', color: '#e74c3c', money: 50, bases: [], units: [] },
  ];
  let currentPlayerIndex = 0;

  const phases = ['Resource', 'Build', 'Move', 'Combat', 'Capture'];
  let currentPhaseIndex = 0;

  // Hex Map Data
  let hexMap = [];

  function hexToPixel(q, r) {
    const x = hexSize * 3/2 * q;
    const y = hexSize * Math.sqrt(3) * (r + q/2);
    return {x, y};
  }

  function drawHex(x, y, fillColor, strokeColor) {
    ctx.beginPath();
    for (let i = 0; i < 6; i++) {
      const angle = Math.PI / 180 * (60 * i);
      const px = x + hexSize * Math.cos(angle);
      const py = y + hexSize * Math.sin(angle);
      if (i === 0) ctx.moveTo(px, py);
      else ctx.lineTo(px, py);
    }
    ctx.closePath();
    ctx.fillStyle = fillColor;
    ctx.fill();
    ctx.strokeStyle = strokeColor;
    ctx.lineWidth = 2;
    ctx.stroke();
  }

  function isInMap(q, r, radius) {
    const s = -q - r;
    return Math.max(Math.abs(q), Math.abs(r), Math.abs(s)) <= radius;
  }

  function drawMap() {
    const centerX = canvas.width / 2;
    const centerY = canvas.height / 2;
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    hexMap = [];

    for(let q = -mapRadius; q <= mapRadius; q++) {
      for(let r = -mapRadius; r <= mapRadius; r++) {
        if(isInMap(q, r, mapRadius)) {
          const {x, y} = hexToPixel(q, r);
          const pixelX = centerX + x;
          const pixelY = centerY + y;
          hexMap.push({
            q, r,
            x: pixelX,
            y: pixelY,
            owner: null,
            base: false,
            units: [],
            structure: null, // 'fort'
            resource: Math.random() < 0.15 ? 5 : 0, // random small resource chance
          });
          drawHex(pixelX, pixelY, '#555', '#222');
        }
      }
    }
  }

  function placeBases() {
    const basePositions = [
      {q: 0, r: -mapRadius},
      {q: mapRadius, r: 0},
      {q: 0, r: mapRadius},
      {q: -mapRadius, r: 0}
    ];
    players.forEach((player, i) => {
      const pos = basePositions[i];
      const tile = hexMap.find(h => h.q === pos.q && h.r === pos.r);
      if(tile) {
        tile.owner = player.id;
        tile.base = true;
        player.bases.push(tile);
      }
    });
  }

  // Draw units and structures as icons
  function drawUnitsAndStructures() {
    hexMap.forEach(tile => {
      if(tile.units.length > 0) {
        tile.units.forEach((unit, idx) => {
          // Draw soldier icon (circle)
          ctx.beginPath();
          ctx.fillStyle = players[unit.owner].color;
          const offsetX = tile.x + (idx * 10) - 10;
          const offsetY = tile.y + 15;
          ctx.arc(offsetX, offsetY, 6, 0, Math.PI * 2);
          ctx.fill();
          ctx.strokeStyle = '#000';
          ctx.stroke();
        });
      }
      if(tile.structure === 'fort') {
        // Draw fort icon (square)
        ctx.fillStyle = '#aaa';
        ctx.fillRect(tile.x - 10, tile.y - 20, 20, 10);
        ctx.strokeStyle = '#000';
        ctx.strokeRect(tile.x - 10, tile.y - 20, 20, 10);
      }
    });
  }

  // UI updates
  function updateUI() {
    const player = players[currentPlayerIndex];
    playerInfoDiv.textContent = `${player.name} (${player.color})`;
    moneyDisplay.textContent = `Gold: ${player.money}`;
    phaseDisplay.textContent = `Phase: ${phases[currentPhaseIndex]}`;
    
    // Enable/disable buttons depending on phase
    buySoldierBtn.disabled = !(phases[currentPhaseIndex] === 'Build' && player.money >= 10);
    buildFortBtn.disabled = !(phases[currentPhaseIndex] === 'Build' && player.money >= 20);
    endTurnBtn.disabled = false;
  }

  // Get tile under mouse
  function getTileAtPosition(x, y) {
    for(const tile of hexMap) {
      const dx = x - tile.x;
      const dy = y - tile.y;
      // simple circle hit test for hex center with some margin
      if(Math.sqrt(dx*dx + dy*dy) < hexSize) {
        return tile;
      }
    }
    return null;
  }

  // Handle canvas mouse move to show tooltip
  canvas.addEventListener('mousemove', e => {
    const rect = canvas.getBoundingClientRect();
    const mouseX = e.clientX - rect.left;
    const mouseY = e.clientY - rect.top;
    const tile = getTileAtPosition(mouseX, mouseY);

    if(tile) {
      tooltip.style.left = (e.clientX + 15) + 'px';
      tooltip.style.top = (e.clientY + 15) + 'px';
      tooltip.style.visibility = 'visible';
      tooltip.innerHTML = `
        <b>Tile [${tile.q},${tile.r}]</b><br/>
        Owner: ${tile.owner !== null ? players[tile.owner].name : 'None'}<br/>
        Base: ${tile.base ? 'Yes' : 'No'}<br/>
        Structure: ${tile.structure ? tile.structure : 'None'}<br/>
        Units: ${tile.units.length}<br/>
        Resources: ${tile.resource}
      `;
    } else {
      tooltip.style.visibility = 'hidden';
    }
  });

  // Hide tooltip when mouse leaves canvas
  canvas.addEventListener('mouseleave', () => {
    tooltip.style.visibility = 'hidden';
  });

  // Click handler for buying/building on selected tile
  let selectedTile = null;
  canvas.addEventListener('click', e => {
    const rect = canvas.getBoundingClientRect();
    const mouseX = e.clientX - rect.left;
    const mouseY = e.clientY - rect.top;
    const tile = getTileAtPosition(mouseX, mouseY);
    if(tile) {
      selectedTile = tile;
      drawMap();
      drawUnitsAndStructures();

      // Highlight selected tile
      ctx.strokeStyle = '#ffff00';
      ctx.lineWidth = 4;
      ctx.beginPath();
      for(let i=0; i<6; i++) {
        const angle = Math.PI / 180 * (60 * i);
        const px = tile.x + hexSize * Math.cos(angle);
        const py = tile.y + hexSize * Math.sin(angle);
        if(i === 0) ctx.moveTo(px, py);
        else ctx.lineTo(px, py);
      }
      ctx.closePath();
      ctx.stroke();

      updateUI();
    }
  });

  // Buy soldier button
  buySoldierBtn.addEventListener('click', () => {
    const player = players[currentPlayerIndex];
    if(selectedTile && selectedTile.owner === player.id && player.money >= 10) {
      selectedTile.units.push({owner: player.id, type: 'soldier'});
      player.money -= 10;
      updateUI();
      drawMap();
      drawUnitsAndStructures();
    }
  });

  // Build fort button
  buildFortBtn.addEventListener('click', () => {
    const player = players[currentPlayerIndex];
    if(selectedTile && selectedTile.owner === player.id && !selectedTile.structure && player.money >= 20) {
      selectedTile.structure = 'fort';
      player.money -= 20;
      updateUI();
      drawMap();
      drawUnitsAndStructures();
    }
  });

  // End turn logic
  endTurnBtn.addEventListener('click', () => {
    // Advance phase or player
    currentPhaseIndex++;
    if(currentPhaseIndex >= phases.length) {
      currentPhaseIndex = 0;
      currentPlayerIndex++;
      if(currentPlayerIndex >= players.length) currentPlayerIndex = 0;
      // Simple resource gain each new turn
      players[currentPlayerIndex].money += 15;
    }
    selectedTile = null;
    drawMap();
    drawUnitsAndStructures();
    updateUI();
  });

  // Initial setup
  drawMap();
  placeBases();
  drawUnitsAndStructures();
  updateUI();
</script>

</body>
</html>